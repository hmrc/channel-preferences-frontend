@(activeCar: Option[uk.gov.hmrc.common.microservice.paye.domain.CarAndFuel],
        carBenefitprevious: Seq[uk.gov.hmrc.common.microservice.paye.domain.CarAndFuel],
        employerName: Option[String], employerSequenceNumber: Int,
        currentTaxYear: Int,
        employmentViews: Seq[models.paye.EmploymentView])(implicit user: uk.gov.hmrc.common.microservice.domain.User)

    @import views.formatting.Dates._
    @import views.formatting.Strings._
    @import views.formatting.Money._

    @displayCarAndFuelBenefit(activeCar: uk.gov.hmrc.common.microservice.paye.domain.CarAndFuel, employerNameString: String) = {

        <table>
            <thead>
                <tr>
                    <th colspan="2" id="company-name">Company car provided by @employerNameString</th>
                </tr>
            </thead>
            <tbody>
            @activeCar.carBenefit.car.map { car =>
                @car.dateCarMadeAvailable.map { dateCarMadeAvailable =>
                    <tr>
                        <td>Date Provided</td>
                        <td id="car-benefit-date-available">@formatDate(dateCarMadeAvailable)</td>
                    </tr>
                }
                @car.carValue.map { carValue =>
                    <tr>
                        <td>List Price including accessories</td>
                        <td>@pounds(carValue)</td>
                    </tr>
                }
                @car.fuelType.map { fuelType =>
                    <tr>
                        <td>Fuel type</td>
                        <td id="car-benefit-fuel-type">@Messages(s"paye.add_car_benefit.fuel_type.$fuelType")</td>
                    </tr>
                }
                @car.co2Emissions.map { co2Emissions =>
                    <tr>
                        <td>Emission figure</td>
                        <td>@co2Emissions g/km</td>
                    </tr>
                }
                @car.engineSize.map { engineSize =>
                    <tr>
                        <td>Engine capacity</td>
                        <td id="car-benefit-engine">@Messages(s"paye.add_car_benefit.engine_capacity.$engineSize")</td>
                    </tr>
                }
            <tr>
                <td>Private Fuel</td>
                <td id="private-fuel">
                @activeCar.fuelBenefit.map { fuelBenefit =>
                    @fuelBenefit.dateWithdrawn.map { dateWithdrawn =>
                        @{Messages("paye.add_car_benefit.employer_pay_fuel.date", employerNameString) + " " + formatDate(fuelBenefit.dateWithdrawn, "")}
                    }.getOrElse {
                        @Messages("paye.add_car_benefit.employer_pay_fuel.true")
                    }
                }.getOrElse {
                    @Messages("paye.add_car_benefit.employer_pay_fuel.false")
                }
                </td>
            </tr>
            <tr>
                <th colspan="2">Taxable benefit value</th>
            </tr>
            <tr>
                <td colspan="2">These amounts are added to your income and you pay tax on them.</td>
            </tr>
            <tr>
                <td>Car benefit taxable value</td>
                <td id="car-benefit-amount">@pounds(activeCar.carBenefit.grossAmount)</td>
            </tr>
                @if(activeCar.fuelBenefit.isDefined) {
                    <tr>
                        <td>Fuel benefit taxable value</td>
                        <td id="fuel-benefit-amount">@pounds(activeCar.fuelBenefit.get.grossAmount)</td>
                    </tr>
                }
            </tbody>

        </table>
    }
    }

    @main(title = "Your tax home", user = Some(user)) {
        <h1><span class="pre-heading">service</span> Tell HMRC about a change to your company car</h1>

        @defining(optionalValue(employerName, "your.employer", false)) { employerNameString =>

            <div class="overview__actions">
                <h2 class="overview__sub-heading">Recent changes</h2>
                <ul class="overview__actions__done" data-recent-changes>
                    @if(employmentViews.flatMap(e => e.recentChanges).size > 0) {
                        @for(employmentView <- employmentViews) {
                            @for(recentChange <- employmentView.recentChanges) {
                                @defining(joinList(recentChange.types.map(b => Messages(s"benefitType.${b}.title")), s" ${Messages("list.separator.and")} ")) { benefitsTitle =>
                                    <li>@Messages(s"recent.change.${recentChange.messageCode}", formatDate(recentChange.timeUserRequestedChange), benefitsTitle, employerNameString, employmentView.taxCode)</li>
                                }
                            }
                        }
                    } else {
                        <li class="no_actions" >There are no changes to your tax in the last month.</li>
                    }
                </ul>
            </div>
            <h2>Your company car</h2>
        @activeCar.map { carBenefit =>
            @displayCarAndFuelBenefit(carBenefit, employerNameString)
        }.getOrElse {
            <p>You do not have an existing company car benefit.</p>
        }

        @if(carBenefitprevious.length > 0) {
            <h2>Previous cars in this tax year</h2>

            @for(carAndFuelBenefit <- carBenefitprevious) {
                @displayCarAndFuelBenefit(carAndFuelBenefit, employerNameString)
            }
        } else {
            <p>You do not have any previous company car benefit.</p>
        }

            <h2>Make Changes</h2>
            <p>
                You can make the following changes to the information HMRC has about your company car
            </p>
        @activeCar.map { car =>
        <ul>
            <li>
                @helpers.link("rm-car-link", s"${controllers.paye.routes.ShowRemoveBenefitFormController.showBenefitRemovalForm(car.carBenefit.benefitType.toString, car.carBenefit.taxYear, car.carBenefit.employmentSequenceNumber)}", "remove your company car")
            </li>
            <li>@car.fuelBenefit.map { fuelBenefit =>
                @helpers.link("rm-fuel-link", s"${controllers.paye.routes.ShowRemoveBenefitFormController.showBenefitRemovalForm(fuelBenefit.benefitType.toString, fuelBenefit.taxYear, fuelBenefit.employmentSequenceNumber)}", "remove your car fuel benefit")
            }.getOrElse {
                @if(car.carBenefit.car.get.fuelType != Some("electricity")) {
                    @helpers.link("add-fuel-link", s"${controllers.paye.routes.AddFuelBenefitController.startAddFuelBenefit(currentTaxYear, employerSequenceNumber)}", "add a car fuel benefit")
                }
            }</li>
        </ul>
        }.getOrElse {
            <div id="no-car-benefit-container">
                <ul>
                    <li>
                    @helpers.link("add-car-link", s"${controllers.paye.routes.AddCarBenefitController.startAddCarBenefit(currentTaxYear, employerSequenceNumber)}", "add a company car (including any fuel benefit you may have)")
                    </li>
                </ul>
            </div>
        }
            <p>If you do not need to make any changes you can @helpers.link("", s"${common.routes.LoginController.logout}", "log out from your account").</p>
        }
    }